# 第三阶段：核心功能实现

## 任务目标

实现 Dropit 应用的核心功能，包括文本同步、图片上传、实时数据轮询和一键复制功能，构建完整的剪贴板应用。

## 任务拆解

### 任务3.1：存储工具函数开发

#### 提示词
```
请帮我实现 Dropit 项目的存储相关工具函数，在 lib/storage.ts 文件中：
1. 实现 Vercel KV 操作函数：
   - 连接 Vercel KV 服务
   - 实现内容的读取、写入、更新和删除
   - 处理连接错误和重试逻辑
   - 支持内容类型标识（文本/图片）

2. 实现 Vercel Blob 操作函数：
   - 连接 Vercel Blob 服务
   - 实现图片文件的上传、下载和删除
   - 处理文件大小限制和类型验证
   - 生成安全的文件访问URL

3. 实现数据同步函数：
   - 获取最新内容的时间戳
   - 比较内容版本差异
   - 处理并发更新冲突
   - 提供内容历史记录

4. 实现错误处理和日志：
   - 记录存储操作日志
   - 处理网络连接错误
   - 提供重试机制
   - 返回详细的错误信息
```

#### 测试方法
1. **单元测试**：
   - 准备创建一个 `__tests__/lib/storage.test.ts` 文件
   - 测试 KV 存储的读写操作
   - 测试 Blob 存储的文件操作
   - 测试数据同步逻辑

2. **集成测试**：
   - 测试与 Vercel 服务的实际连接
   - 验证数据存储和读取的准确性
   - 测试错误处理和重试机制

### 任务3.2：内容管理API实现

#### 提示词
```
请帮我实现 Dropit 项目的内容管理API，在 app/api/content/route.ts 文件中：
1. 实现 GET 方法获取内容：
   - 从 Vercel KV 读取最新内容
   - 返回内容类型、数据和时间戳
   - 处理内容不存在的情况
   - 支持内容过滤和分页

2. 实现 POST 方法更新内容：
   - 接收文本内容并存储到 KV
   - 验证内容格式和长度
   - 更新内容时间戳
   - 返回操作结果

3. 实现 DELETE 方法清除内容：
   - 清除当前存储的内容
   - 清理相关的 Blob 文件
   - 记录清除操作日志
   - 返回清除结果

4. 实现内容验证和清理：
   - 验证内容格式和大小
   - 清理过期或无效内容
   - 处理存储空间限制
   - 提供内容统计信息
```

#### 测试方法
1. **API测试**：
   - 使用 Postman 测试内容获取接口
   - 测试内容更新和删除功能
   - 验证错误处理和响应格式

2. **单元测试**：
   - 准备创建一个 `__tests__/api/content.test.ts` 文件
   - 使用 MSW 模拟存储操作
   - 测试各种内容操作场景

### 任务3.3：图片上传API实现

#### 提示词
```
请帮我实现 Dropit 项目的图片上传API，在 app/api/upload/route.ts 文件中：
1. 实现图片上传处理：
   - 接收 multipart/form-data 格式的图片
   - 验证图片文件类型和大小
   - 生成唯一的文件名
   - 上传到 Vercel Blob 存储

2. 实现图片处理优化：
   - 压缩图片文件大小
   - 生成缩略图
   - 支持多种图片格式
   - 优化存储空间使用

3. 实现安全验证：
   - 验证文件类型白名单
   - 检查文件大小限制
   - 防止恶意文件上传
   - 生成安全的访问URL

4. 实现元数据管理：
   - 存储图片元信息到 KV
   - 记录上传时间和用户信息
   - 管理图片生命周期
   - 提供图片统计信息
```

#### 测试方法
1. **上传测试**：
   - 测试不同格式图片的上传
   - 验证文件大小限制
   - 测试恶意文件防护

2. **单元测试**：
   - 准备创建一个 `__tests__/api/upload.test.ts` 文件
   - 测试图片处理逻辑
   - 验证安全措施

### 任务3.4：剪贴板组件实现

#### 提示词
```
请帮我实现 Dropit 项目的核心剪贴板组件，在 components/Clipboard.tsx 文件中：
1. 实现内容展示区域：
   - 根据内容类型显示文本或图片
   - 支持内容编辑和更新
   - 显示内容时间戳和状态
   - 提供内容操作按钮

2. 实现粘贴功能：
   - 监听 paste 事件
   - 支持文本和图片粘贴
   - 自动识别内容类型
   - 调用相应的API进行存储

3. 实现一键复制功能：
   - 文本内容复制到剪贴板
   - 图片内容下载或复制
   - 提供复制成功反馈
   - 处理复制失败情况

4. 实现实时同步：
   - 使用 SWR 进行数据轮询
   - 自动检测内容变化
   - 显示同步状态指示
   - 处理网络错误和重连
```

#### 测试方法
1. **组件测试**：
   - 准备创建一个 `__tests__/components/Clipboard.test.tsx` 文件
   - 测试内容展示和编辑
   - 测试粘贴和复制功能

2. **用户交互测试**：
   - 测试文本和图片粘贴
   - 验证一键复制功能
   - 测试实时同步效果

### 任务3.5：图片上传组件实现

#### 提示词
```
请帮我实现 Dropit 项目的图片上传组件，在 components/ImageUpload.tsx 文件中：
1. 实现拖拽上传功能：
   - 支持拖拽文件到指定区域
   - 显示拖拽状态和反馈
   - 验证文件类型和大小
   - 提供上传进度指示

2. 实现粘贴上传功能：
   - 监听页面粘贴事件
   - 自动识别图片内容
   - 显示粘贴预览
   - 处理粘贴错误

3. 实现文件选择功能：
   - 提供文件选择按钮
   - 支持多文件选择
   - 显示文件信息预览
   - 处理文件验证错误

4. 实现上传状态管理：
   - 显示上传进度条
   - 处理上传成功和失败
   - 提供重试机制
   - 显示上传结果反馈
```

#### 测试方法
1. **组件测试**：
   - 准备创建一个 `__tests__/components/ImageUpload.test.tsx` 文件
   - 测试各种上传方式
   - 验证文件验证逻辑

2. **功能测试**：
   - 测试拖拽上传功能
   - 测试粘贴上传功能
   - 验证上传状态显示

### 任务3.6：实时数据同步实现

#### 提示词
```
请帮我实现 Dropit 项目的实时数据同步功能：
1. 配置 SWR 数据获取：
   - 设置合适的轮询间隔（2-3秒）
   - 配置错误重试策略
   - 实现数据缓存管理
   - 处理网络连接状态

2. 实现内容变化检测：
   - 比较内容版本差异
   - 检测内容类型变化
   - 处理并发更新冲突
   - 提供变化通知

3. 实现离线支持：
   - 缓存最后已知内容
   - 显示离线状态指示
   - 自动重连和同步
   - 处理数据冲突

4. 实现性能优化：
   - 减少不必要的API调用
   - 优化数据更新逻辑
   - 实现智能轮询策略
   - 提供性能监控
```

#### 测试方法
1. **同步测试**：
   - 测试多设备间的数据同步
   - 验证轮询间隔的准确性
   - 测试网络中断和恢复

2. **性能测试**：
   - 测试大量数据同步的性能
   - 验证内存使用情况
   - 测试长时间运行的稳定性

## 完成标准

1. ✅ 存储工具函数正常工作
2. ✅ 内容管理API响应正常
3. ✅ 图片上传功能完整
4. ✅ 剪贴板组件可用
5. ✅ 图片上传组件可用
6. ✅ 实时同步功能正常
7. ✅ 所有功能通过测试验证

## 测试验证清单

- [ ] 存储操作单元测试通过
- [ ] 内容管理API测试通过
- [ ] 图片上传功能测试通过
- [ ] 剪贴板组件测试通过
- [ ] 图片上传组件测试通过
- [ ] 实时同步功能测试通过
- [ ] 端到端功能测试通过

## 下一步

完成核心功能后，进入第四阶段：功能完善和优化，包括错误处理、用户体验优化、性能优化和部署上线。
