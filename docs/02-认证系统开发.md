# 第二阶段：认证系统开发

## 任务目标

实现 Dropit 应用的核心认证系统，包括密码验证、JWT 令牌管理、会话状态管理和用户访问控制。

## 任务拆解

### 任务2.1：认证工具函数开发

#### 提示词
```
请帮我实现 Dropit 项目的认证相关工具函数，在 lib/auth.ts 文件中：
1. 实现密码验证函数：
   - 使用 bcryptjs 进行密码哈希比较
   - 支持环境变量中的 APP_PASSWORD 配置
   - 返回验证结果和错误信息

2. 实现 JWT 令牌生成函数：
   - 使用 jsonwebtoken 生成访问令牌
   - 设置合适的过期时间（如24小时）
   - 使用环境变量中的 JWT_SECRET

3. 实现 JWT 令牌验证函数：
   - 验证令牌的有效性和完整性
   - 检查令牌是否过期
   - 返回验证结果和用户信息

4. 实现令牌刷新函数：
   - 检查令牌是否即将过期
   - 自动生成新的令牌
   - 处理令牌刷新逻辑
```

#### 测试方法
1. **单元测试**：
   - 准备创建一个 `__tests__/lib/auth.test.ts` 文件
   - 测试密码验证函数的正确性
   - 测试 JWT 令牌生成和验证
   - 测试令牌刷新逻辑

2. **功能测试**：
   - 使用不同的密码组合测试验证逻辑
   - 测试 JWT 令牌的过期处理
   - 验证错误情况的处理

### 任务2.2：认证API端点实现

#### 提示词
```
请帮我实现 Dropit 项目的认证API端点，在 app/api/auth/route.ts 文件中：
1. 实现 POST 方法处理登录请求：
   - 接收包含密码的请求体
   - 调用密码验证函数
   - 验证成功后生成 JWT 令牌
   - 返回令牌和成功状态

2. 实现错误处理：
   - 密码错误时返回401状态
   - 请求格式错误时返回400状态
   - 服务器错误时返回500状态

3. 实现安全措施：
   - 限制请求频率（防止暴力破解）
   - 记录登录尝试日志
   - 设置适当的响应头

4. 实现响应格式：
   - 统一的响应结构
   - 包含状态码、消息和数据
   - 支持错误详情信息
```

#### 测试方法
1. **API测试**：
   - 使用 Postman 或 curl 测试登录接口
   - 测试正确的密码登录
   - 测试错误的密码登录
   - 测试无效的请求格式

2. **单元测试**：
   - 准备创建一个 `__tests__/api/auth.test.ts` 文件
   - 使用 MSW 模拟 API 请求
   - 测试各种响应状态和错误情况

3. **安全测试**：
   - 测试暴力破解防护
   - 验证响应头安全性
   - 检查日志记录功能

### 任务2.3：认证状态管理

#### 提示词
```
请帮我实现 Dropit 项目的认证状态管理，使用 Zustand 创建状态存储：
1. 创建认证状态存储 (lib/stores/auth.ts)：
   - 管理用户认证状态
   - 存储 JWT 令牌
   - 提供登录、登出、令牌刷新等方法

2. 实现持久化存储：
   - 使用 sessionStorage 存储令牌
   - 页面刷新后自动恢复认证状态
   - 处理令牌过期的情况

3. 实现自动令牌刷新：
   - 检测令牌即将过期
   - 自动调用刷新接口
   - 更新存储中的令牌

4. 提供状态查询方法：
   - 检查用户是否已认证
   - 获取当前令牌
   - 检查令牌是否有效
```

#### 测试方法
1. **状态管理测试**：
   - 准备创建一个 `__tests__/stores/auth.test.ts` 文件
   - 测试状态初始化和更新
   - 测试持久化存储功能
   - 测试自动令牌刷新逻辑

2. **集成测试**：
   - 测试登录流程的完整状态变化
   - 测试登出流程的状态清理
   - 测试页面刷新后的状态恢复

### 任务2.4：认证表单组件

#### 提示词
```
请帮我实现 Dropit 项目的认证表单组件，在 components/AuthForm.tsx 文件中：
1. 创建密码输入表单：
   - 使用 react-hook-form 管理表单状态
   - 实现密码输入验证
   - 提供提交和重置功能

2. 实现表单验证：
   - 密码不能为空
   - 密码长度限制
   - 实时验证反馈

3. 集成认证逻辑：
   - 调用认证API进行登录
   - 处理登录成功和失败
   - 显示加载状态和错误信息

4. 实现用户体验优化：
   - 响应式设计
   - 加载状态指示
   - 错误信息展示
   - 成功后的自动跳转
```

#### 测试方法
1. **组件测试**：
   - 准备创建一个 `__tests__/components/AuthForm.test.tsx` 文件
   - 测试表单渲染和交互
   - 测试表单验证逻辑
   - 测试提交和重置功能

2. **用户交互测试**：
   - 测试密码输入和验证
   - 测试表单提交流程
   - 测试错误处理和显示

3. **样式测试**：
   - 验证响应式布局
   - 检查加载状态显示
   - 确认错误信息样式

### 任务2.5：认证中间件和路由保护

#### 提示词
```
请帮我实现 Dropit 项目的认证中间件和路由保护：
1. 创建认证中间件 (middleware.ts)：
   - 检查请求路径是否需要认证
   - 验证 JWT 令牌的有效性
   - 重定向未认证用户到登录页

2. 实现路由保护逻辑：
   - 保护需要认证的页面
   - 处理令牌过期的情况
   - 提供友好的重定向体验

3. 配置中间件规则：
   - 保护 API 路由
   - 保护主页面
   - 允许登录页面访问

4. 实现错误处理：
   - 处理无效令牌
   - 处理过期令牌
   - 记录认证失败日志
```

#### 测试方法
1. **中间件测试**：
   - 准备创建一个 `__tests__/middleware.test.ts` 文件
   - 测试不同路径的认证要求
   - 测试令牌验证逻辑
   - 测试重定向行为

2. **集成测试**：
   - 测试完整的认证流程
   - 测试未认证用户的访问限制
   - 测试令牌过期后的处理

## 完成标准

1. ✅ 密码验证功能正常工作
2. ✅ JWT 令牌生成和验证正确
3. ✅ 认证API端点响应正常
4. ✅ 状态管理功能完整
5. ✅ 认证表单组件可用
6. ✅ 路由保护机制生效
7. ✅ 所有功能通过测试验证

## 测试验证清单

- [ ] 密码验证函数单元测试通过
- [ ] JWT 令牌功能测试通过
- [ ] 认证API接口测试通过
- [ ] 状态管理测试通过
- [ ] 认证表单组件测试通过
- [ ] 中间件功能测试通过
- [ ] 端到端认证流程测试通过

## 下一步

完成认证系统后，进入第三阶段：核心功能实现，包括文本同步、图片上传、实时数据轮询等功能的开发。
